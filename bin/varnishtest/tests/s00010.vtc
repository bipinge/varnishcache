varnishtest "client h1 send timeouts - tcp"

# XXX See https://github.com/varnishcache/varnish-cache/pull/2980#issuecomment-486214661
feature cmd {test $(uname) != "SunOS" && test $(uname) != "Darwin"}

feature SO_RCVTIMEO_WORKS

server s1 {
	rxreq
	txresp -bodylen 100000
} -start

varnish v1				\
	-arg "-p debug=+flush_head"	\
	-arg "-p thread_pools=1"	\
	-arg "-p timeout_idle=1"	\
	-arg "-p idle_send_timeout=.1"	\
	-arg "-p send_timeout=.1"	\
	-arg "-a 127.0.0.1:0"		\
	-vcl+backend {
	import debug;

	sub vcl_deliver {
		debug.sndbuf(128b);
	}
} -start

logexpect l1 -v v1 {
	expect * 1001 Debug	"Hit total send timeout"
	expect * 1000 SessClose	TX_ERROR
} -start

client c1 -rcvbuf 128 {
	txreq
	non_fatal
	rxresphdrs
	# keep the session open
	delay 4
	# avoid a broken pipe
	rxrespbody
} -start

client c1 -wait
logexpect l1 -wait

varnish v1 -cliok "param.set idle_send_timeout 1"
varnish v1 -cliok "param.reset send_timeout"

logexpect l2 -v v1 {
	expect * 1004 Debug	"Hit idle send timeout"
	expect * 1003 SessClose	TX_ERROR
} -start

client c1 -run
logexpect l2 -wait
