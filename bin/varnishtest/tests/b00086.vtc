varnishtest "connect: blackhole with queueing"

varnish v1 -vcl {
       backend default {
               # Non-routeable IPv4 address to simulate connect_timeout
               .host = "${bad_ip}";
               .max_connections = 1;
               .wait_limit = 1;
               .wait_timeout = 0.2s;
       }
} -start

varnish v1 -cli "param.set connect_timeout 2"

client c1 {
       txreq -url "/blackhole"
       rxresp
       expect resp.status == 503
} -start

client c2 {
       txreq -url "/bye"
       rxresp
       expect resp.status == 503
} -start

client c1 -wait
client c2 -wait

varnish v1 -expect MAIN.backend_conn == 0
varnish v1 -expect MAIN.backend_busy == 1
varnish v1 -expect MAIN.backend_wait_fail == 1
varnish v1 -expect MAIN.backend_fail == 1

