varnishtest "Test must-revalidate"

server s1 {
	rxreq
	txresp -hdr "Cache-Control: max-age=30"
	rxreq
	txresp -hdr "Cache-Control: max-age=30, must-revalidate"	
	rxreq
	txresp -hdr "Cache-Control: max-age=30, must-revalidate, stale-while-revalidate=100"		
} -start

varnish v1 -vcl+backend {
	sub vcl_backend_response {
		set beresp.http.grace = beresp.grace;
		set beresp.http.ttl = beresp.ttl;
	}
} -start

client c1 {
	txreq -url /1
	rxresp
	expect resp.http.grace == 10.000

	txreq -url /2
	rxresp
	expect resp.http.grace == 0.000

	txreq -url /3
	rxresp
	expect resp.http.grace == 0.000
} -run
