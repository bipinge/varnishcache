varnishtest "h1 send_timeout and streaming of dripping chunks"

barrier b cond 2

server s1 {
	rxreq
	txresp -nolen -hdr "Transfer-Encoding: chunked"
	chunkedlen 1
	delay 1
	non_fatal
	barrier b sync
	chunkedlen 1
	delay 1
	chunkedlen 0
} -start

varnish v1 -cliok "param.set idle_send_timeout .1"
varnish v1 -cliok "param.set send_timeout .8"
varnish v1 -vcl+backend { } -start

logexpect l1 -v v1 {
	expect * * DeliveryError	{resp: "Error transaction" \d+ ".*"}
	expect 0 = Timestamp		"Resp:"
} -start

client c1 {
	txreq
	rxresphdrs
	rxchunk
	barrier b sync
	expect_close
} -run

logexpect l1 -wait
